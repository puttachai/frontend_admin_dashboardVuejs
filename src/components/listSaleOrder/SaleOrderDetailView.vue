<template>

  <div
    class="mainbox flex flex-col in-h-screen items-center gap-4 justify-center bg-gray-100 py-8 px-4 sm:px-6 lg:px-8">

    <!-- กล่องรวม breadcrumb + action bar -->
    <div class="fixed top-16 left-16 right-0 bg-white rounded-lg p-4 shadow-lg z-50 responsive-action-bar">

      <!-- Breadcrumb + ActionBar inline -->
      <div class="flex flex-wrap md:flex-nowrap justify-between  items-center gap-4">

        <!-- Breadcrumb -->
        <nav class="text-sm text-gray-600">
          <ul class="flex items-center space-x-1">
            <li>
              <router-link to="/dashboard" class="hover:text-purple-600 transition">Home</router-link>
              <span class="mx-1 text-gray-400">›</span>
            </li>
            <li>
              <router-link to="/saleorder" class="hover:text-purple-600 transition">Sale Order List</router-link>
              <span class="mx-1 text-gray-400">›</span>
            </li>
            <li class="text-purple-600 font-medium">
              {{ currentDocumentNo || 'Loading...' }}
            </li>
          </ul>
        </nav>

        <!-- Action Bar -->
        <div class="flex flex-wrap justify-end gap-3 responsive-action-buttons md:gap-4 md:flex-nowrap">

          <!-- ปุ่ม บันทึก -->
          <!-- <button v-if="!isReadOnly && isCreatePage" @click="saveDocument" -->
          <button @click="saveDocument"
            class="flex items-center gap-2 bg-green-500 text-white py-2 px-4 md:px-6 text-sm md:text-base rounded-md hover:bg-green-700 transition duration-300 shadow hover:shadow-lg">
            <span class="material-icons">add_task</span>
            <span>อนุมัติเอกสาร</span>
          </button>
        </div>
      </div>
    </div>


    <!-- form รายการเอกสาร -->
    <div class="boxback w-full mt-20 gap-4 bg-white p-8 rounded-lg shadow-lg">

      <div>
        <!-- Logo and Title -->
        <div class="text-center mb-4 ">
          <img src="../../assets/logo.svg" alt="Logo" class="mx-auto h-16">
          <p class="mt-1 text-xl text-gray-700">รายละเอียดคำสั่งซื้อ</p>
        </div>

        <div class="flex items-center gap-2 mb-4">
          <span class="material-icons text-purple-600">content_paste</span>
          <h1 class="text-xl text-gray-700">ข้อมูล</h1>
        </div>

        <!-- แสดงภาพที่อัปโหลด -->
        <!-- <div class="md:col-span-2 mb-4 pb-4" v-if="previewImage">
                  <p class="text-sm text-gray-500 mb-2">Preview:</p>
                  <img :src="previewImage" alt="Uploaded Image"
                      class="object-cover rounded-md border w-[100px] h-[100px]" />
              </div> -->


        <!-- แบบฟอร์มส่วนที่1  -->
        <form class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">รายการ *</label>
            <div>
              <input type="text" placeholder="รหัสรายการ" disabled v-model="formData.documentNo"
                class="border mt-1.5 block w-full text-gray-700 rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
            </div>

          </div>

          <!-- <div>
                      <label class="block text-sm font-medium text-gray-700">วันที่</label>
                      <input type="date" v-model="formData.sellDate" disabled
                          class="border mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
                  </div> -->

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่</label>
            <div class="relative">
              <!-- Flatpickr Input -->
              <flat-pickr v-model="formData.sellDate" :config="dateConfig" disabled placeholder="เลือกวันที่"
                class="pl-4 pr-10 py-2 mt-1 w-full rounded-md border border-gray-300 text-gray-700 placeholder-gray-400 shadow-sm focus:ring-purple-500 focus:border-purple-500"></flat-pickr>

              <!-- Calendar Icon -->
              <span class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                <span class="material-icons text-gray-400 text-base">calendar_today</span>
              </span>
            </div>
          </div>




          <!-- เงื่อนไขแสดงเพิ่มเติม -->
          <div v-if="showMoreData" :key="showMoreData" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">

            <div>
              <label class="block text-sm font-medium text-gray-700">อ้างอิง</label>
              <input type="text" v-model="formData.reference" disabled :readonly="isReadOnly"
                class="border text-gray-700 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">ช่องทางการขาย</label>
              <input type="text" v-model="formData.channel" disabled :readonly="isReadOnly"
                class="border text-gray-700 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700">ประเภทภาษี</label>
              <input type="text" v-model="formData.taxType" disabled :readonly="isReadOnly"
                class="border text-gray-700 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
            </div>

          </div>

        </form>
        <!-- ปุ่ม Show More / Show Less , <button @click="showMoreData = !showMoreData" type="button" -->
        <button @click="toggleShowMoreData" type="button"
          class="mt-4 text-purple-600 hover:underline focus:outline-none ">
          {{ showMoreData ? 'แสดงน้อยลง ▲' : 'แสดงเพิ่มเติม ▼' }}
        </button>
      </div>


      <!-- หัวข้อ "แบบฟอร์มลูกค้า" ด้านซ้าย และ "แบบฟอร์มสินค้า" ด้านขวา -->
      <div class="gap-6 items-start mt-4">

        <!-- แบบฟอร์มลูกค้า: อยู่ฝั่งซ้าย -->
        <div>
          <!-- หัวข้อ -->
          <div class="flex items-center gap-2 mb-4">
            <span class="material-icons text-blue-600">account_circle</span>
            <h1 class="text-xl text-gray-700">แบบฟอร์มลูกค้า</h1>
          </div>

          <!-- แบบฟอร์ม -->
          <form class="grid grid-cols-1 gap-4">
            <!-- แสดงเสมอ -->
            <div>
              <label class="block text-sm font-medium text-gray-700">ชื่อลูกค้า</label>
              <input type="text" placeholder="ชื่อ, รหัส" disabled v-model="formData.fullName"
                class="mt-1 block w-full text-gray-700 rounded-md border border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
              <p v-if="formTouched && errors.fullName" class="text-red-500 text-sm mt-1">{{
                errors.fullName }}</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">รหัสลูกค้า</label>
              <input type="text" v-model="formData.customerCode" disabled
                class="mt-1 block w-full text-gray-700 rounded-md border border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
              <p v-if="formTouched && errors.customerCode" class="text-red-500 text-sm mt-1">{{
                errors.customerCode }}
              </p>
            </div>

            <!-- เงื่อนไขแสดงเพิ่มเติม -->
            <div v-if="showMore">
              <div class="">
                <label class="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ลูกค้า</label>
                <input type="text" v-model="formData.phone" disabled :readonly="isReadOnly"
                  class="mt-1 block w-full text-gray-700 rounded-md border border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
              </div>

              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">อีเมลลูกค้า</label>
                <input type="text" v-model="formData.email" disabled :readonly="isReadOnly"
                  class="mt-1 block w-full text-gray-700 rounded-md border border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
              </div>

              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">ที่อยู่ลูกค้า
                  <span class="text-red-500 text-xs">*</span>
                  <span class="text-red-500 text-xs">กรุณากรอกข้อมูลนี้ที่แบบฟอร์มที่ 3
                    ข้อมูลที่อยู่ผู้รับ</span>
                </label>
                <input type="text" v-model="formData.address" disabled :readonly="isReadOnly"
                  class="mt-1 block w-full text-gray-700 rounded-md border border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500" />
                <!-- <p v-if="formTouched && errors.address" class="text-red-500 text-sm mt-1">{{
                                  errors.address }}</p> -->
              </div>
            </div>
          </form>

          <!-- ปุ่ม Show More / Show Less -->
          <button @click="showMore = !showMore" type="button"
            class="mt-4 text-purple-600 hover:underline focus:outline-none">
            {{ showMore ? 'แสดงน้อยลง ▲' : 'แสดงเพิ่มเติม ▼' }}
          </button>
          <p v-if="formTouched && errors.address" class="text-red-500 text-sm mt-1">{{
            errors.address }}</p>
        </div>

      </div>

    </div>

    <!-- หน้าสินค้า -->
    <div class="w-full mx-auto p-6 bg-white rounded-lg shadow-md">

      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <!-- ส่วนซ้าย ไอคอนและสินค้า -->
        <div class="flex items-center gap-2">
          <span class="material-icons text-purple-600">assignment_add</span>
          <h2 class="text-xl font-semibold text-gray-700">สินค้า</h2>
        </div>



        <!-- Dropdown สำหรับหน้าจอเล็ก -->

      </div>



      <!-- Popup Component -->

      <div class="overflow-x-auto">
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr class="text-center">
              <th class="px-4 py-2 border">รหัส</th>
              <th class="px-4 py-2 border">รูปภาพ</th>
              <th class="px-4 py-2 border">ชื่อสินค้า *</th>
              <th class="px-4 py-2 border">สี</th>
              <th class="px-4 py-2 border">จำนวน *</th>
              <!-- <th class="px-4 py-2 border">คงเหลือ *</th> -->
              <th class="px-4 py-2 border">มูลค่าต่อหน่วย *</th>
              <th class="px-4 py-2 border">ส่วนลดต่อหน่วย</th>
              <th class="px-4 py-2 border">รวม</th>
              <!-- <th class="px-4 py-2 border text-center">ลบ</th> -->
            </tr>
          </thead>

          <tbody v-if="isLoading">
            <tr>
              <td colspan="10" class="py-10 text-center">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                  viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                </svg>
                <div class="mt-2 text-gray-500">กำลังโหลดข้อมูล...</div>
              </td>
            </tr>
          </tbody>

          <tbody v-if="!isLoading">
            <!-- แสดงรายการสินค้า -->
            <!-- 👉 Group by pro_activity_id -->
            <template v-for="(group, activityId) in groupByActivityId(selectedProducts)" :key="activityId">
              <!-- 🔁 Loop สินค้าในกลุ่มนั้น -->
              <template v-for="(product, index) in group" :key="product.pro_id">
                <!-- 🔳 สินค้า -->
                <tr class="text-center bg-white">
                  <td class="px-4 py-2 border">{{ product.pro_id }}</td>
                  <td class="px-4 py-2 border">
                    <template v-if="product.pro_images">
                      <img
                        :src="product.pro_images.startsWith('http') ? product.pro_images : BASE_URL_IMAGE + product.pro_images"
                        class="w-10 h-10 rounded-full mx-auto" />
                    </template>
                    <template v-else>
                      <span class="material-icons text-gray-400 text-4xl">broken_image</span>
                    </template>
                  </td>
                  <td class="px-4 py-2 border">{{ product.pro_erp_title == 0 ? product.pro_title :
                    product.pro_erp_title }}</td>
                  <td class="px-4 py-2 border">{{ product.pro_goods_sku_text || '-' }}</td>
                  <!-- <td class="px-4 py-2 border">{{ product.pro_quantity }}</td> -->
                  <!-- <td class="px-4 text-gray-700 py-2 border">
                                      <input type="number" v-model.pro_quantity="product.pro_quantity" min="1" placeholder="จำนวน"
                                          class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                  </td> -->
                  <!-- <td class="px-4 py-2 border">
                                      <input type="number" :min="0" :max="product.pro_stock" step="1"
                                          v-model.number="product.pro_quantity" @input="validateQuantity(product)"
                                          class="w-full px-2 py-1 border rounded" />
                                  </td> -->
                  <td class="px-4 py-2 border">{{ product.pro_quantity }}</td>
                  <!-- <td class="px-4 py-2 border">{{ product.pro_stock }}</td> -->
                  <td class="px-4 py-2 border">{{ product.pro_unit_price }}</td>
                  <td class="px-4 py-2 border">{{ product.discount || 0 }}</td>
                  <td class="px-4 py-2 border">{{ totalprice(product) }}</td>
                  <!-- <td class="px-4 py-2 border text-red-500 cursor-pointer hover:text-red-700"
                                      :disabled="isReadOnly"
                                      @click="removeProduct(index, activityId)">
                                      ลบ
                  </td> -->
                  <!-- ใช้ได้ -->
                  <!-- <td class="px-4 py-2 border" :class="{
                    'text-red-500 cursor-pointer hover:text-red-700': !isReadOnly,
                    'text-gray-400 cursor-not-allowed': isReadOnly
                  }" @click="!isReadOnly && removeProduct(index, activityId)">
                    ลบ
                  </td> -->
                </tr>
              </template>

              <!-- 🟦 โปรโมชั่น (มินิมอล + ลูกเล่นไอคอน) -->
              <tr v-if="group[0].promotions && group[0].promotions.length > 0"
                class="bg-blue-50 hover:bg-blue-100 transition-colors duration-300">
                <td colspan="9" class="px-6 py-4 border rounded-md">
                  <div class="flex items-center space-x-2 text-blue-800 font-medium">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" stroke-width="2"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M13 16h-1v-4h-1m2-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>โปรโมชั่น</span>
                  </div>
                  <ul class="list-disc list-inside ml-6 mt-2 text-sm text-gray-700">
                    <li v-for="(promotion, promoIndex) in group[0].promotions" :key="promoIndex">
                      {{ promotion.title }}
                    </li>
                  </ul>
                </td>
              </tr>


              <!-- 🟨 ของแถม (มินิมอล + รูปภาพ + ฟีล modern card) -->
              <tr v-if="group[0].gifts && group[0].gifts.length > 0"
                class="bg-yellow-50 hover:bg-yellow-100 transition-colors duration-300">
                <td colspan="9" class="px-6 py-4 border rounded-md">
                  <div class="flex items-center space-x-2 text-yellow-800 font-medium">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" stroke-width="2"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 8c-1.1 0-2 .9-2 2m4 0a2 2 0 00-2-2m0 4a2 2 0 002-2m-4 0a2 2 0 012-2m0 4a2 2 0 01-2-2m8-6H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V8l-6-6z" />
                    </svg>
                    <span>ของแถม</span>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                    <div v-for="(gift, giftIndex) in group[0].gifts" :key="giftIndex"
                      class="flex items-center bg-white shadow-sm rounded-lg p-2 border border-gray-200">
                      <img v-if="gift.pro_image"
                        :src="gift.pro_image.startsWith('http') ? gift.pro_image : BASE_URL_IMAGE + gift.pro_image"
                        class="w-12 h-12 object-cover rounded mr-4" alt="gift image" />
                      <div class="text-sm text-gray-800">
                        <div class="font-semibold">{{ gift.title }}</div>
                        <div class="text-gray-500">จำนวน: {{ gift.pro_goods_num }}</div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>

            </template>
          </tbody>
        </table>
      </div>



      <!-- ช่องทางจัดส่ง -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
        <div>
          <label class="block font-medium mb-1 text-gray-700">ช่องทางจัดส่ง
            <span class="text-red-500 text-xs">*</span>
            <span class="text-red-500 text-xs">จำเป็นต้องกรอกข้อมูลนี้</span>
          </label>
          <select v-model="formData.deliveryType" placeholder="ช่องทางจัดส่ง" disabled :disabled="isReadOnly"
            style="margin: 0.4rem;" class="w-full border px-3 py-2 rounded text-gray-700">

            <option value="">เลือกช่องทางจัดส่ง</option>
            <option>ไปรษณีย์</option>
            <!-- <option>ไปรษณีย์</option> -->
            <option>แมสเซนเจอร์</option>
            <option>ขนส่งเอกชน</option>
          </select>
          <p v-if="this.formTouched && errors.deliveryType" class="text-red-500 text-sm mt-1">{{
            errors.deliveryType
          }}</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1 text-gray-700">ส่วนลด</label>
            <input type="text" v-model="formData.totalDiscount" disabled :readonly="isReadOnly"
              class="w-full text-gray-700 border px-3 py-2 rounded text-gray-700" placeholder="จำนวนเงิน หรือ %" />
          </div>
          <div>
            <label class="block font-medium mb-1 text-gray-700">ค่าจัดส่ง</label>
            <input type="number" v-model="formData.deliveryFee" disabled :readonly="isReadOnly"
              class="w-full text-gray-700 border px-3 py-2 rounded text-gray-700" placeholder="ค่าจัดส่ง" />

          </div>
        </div>
      </div>

      <!-- หมายเหตุ -->
      <div class="mt-4">
        <label class="block font-medium mb-1 text-gray-700">หมายเหตุ</label>
        <textarea rows="3" v-model="formData.note" disabled :readonly="isReadOnly"
          class="w-full border px-3 py-2 rounded text-gray-700"></textarea>
      </div>

      <!-- รวม -->
      <!-- รวม -->
      <div class="mt-6 text-right space-y-1">
        <div class="text-gray-700">มูลค่ารวมก่อนภาษี:
          <span class="ml-2 text-gray-700">{{ totalAmountBeforeDiscount.toFixed(2) }}</span>
        </div>

        <div class="text-gray-700 flex items-center justify-end">
          <input type="checkbox" v-model="isVatIncluded" id="vatCheckbox" disabled :disabled="isReadOnly"
            class="mr-2" />
          <label for="vatCheckbox">ภาษีมูลค่าเพิ่ม (7%)</label>
          <span class="ml-2 text-gray-700">
            {{ isVatIncluded ? (totalAmountBeforeDiscount * 0.07).toFixed(2) : '0.00' }}
          </span>
        </div>

        <div class="text-xl font-bold text-purple-700 mt-2">
          มูลค่ารวมสุทธิ:
          <span class="ml-2 text-blue-600">{{ grandTotal }}</span>
        </div>
      </div>

    </div>


    <!-- -ข้อมูลที่อยู่ผู้รับ  -->
    <div class="w-full mx-auto p-6 bg-white rounded-lg shadow-md space-y-8">
      <!-- กล่องหลัก แบ่งเป็น 2 ฝั่ง -->
      <div class="  gap-8">
        <!-- ซ้าย: ข้อมูลที่อยู่ผู้รับ -->
        <div>
          <div class="flex items-center gap-2 mb-4">
            <span class="material-icons text-blue-600">contact_mail</span>
            <h2 class="text-lg font-semibold text-gray-800">ข้อมูลที่อยู่ผู้รับ</h2>
          </div>

          <div class="space-y-4">

            <div>
              <label class="text-sm text-gray-700 block mb-1">
                ชื่อผู้รับ
                <span class="text-red-500 text-xs ml-1">*</span>
                <span class="text-red-500 text-xs ml-1">จำเป็นต้องกรอกข้อมูลนี้</span>
              </label>
              <input type="text" v-model="formData.receiverName" disabled :readonly="isReadOnly"
                class="w-full text-gray-700 border rounded px-3 py-2" />
              <p v-if="formTouched && errors.receiverName" class="text-red-500 text-sm mt-1">
                {{ errors.receiverName }}
              </p>
            </div>

            <!-- <div class="flex items-center gap-2 text-sm text-blue-600 cursor-pointer">
                          <span class="material-icons text-base">content_copy</span>
                          <span>คัดลอกจากข้อมูลลูกค้า</span>
                      </div> -->

            <div>
              <label class="text-sm text-gray-700 block mb-1">เบอร์โทรศัพท์ผู้รับ
                <span class="text-red-500 text-xs ml-1">*</span>
                <span class="text-red-500 text-xs ml-1">จำเป็นต้องกรอกข้อมูลนี้</span>
              </label>
              <input type="tel" v-model="formData.receiverPhone" disabled :readonly="isReadOnly"
                class="w-full text-gray-700 border rounded px-3 py-2" />
              <p v-if="formTouched && errors.receiverPhone" class="text-red-500 text-sm mt-1">{{
                errors.receiverPhone }}
              </p>
            </div>

            <div v-if="showMoreAdress">

              <div>
                <label class="text-sm text-gray-700 block mb-1">อีเมลผู้รับ</label>
                <input type="email" v-model="formData.receiverEmail" disabled :readonly="isReadOnly"
                  class="w-full text-gray-700 border rounded px-3 py-2" />
              </div>

              <div class="mt-4">
                <label class="text-sm text-gray-700 block mb-1">ที่อยู่/จัดส่ง
                  <span class="text-red-500 text-xs ml-1">*</span>
                  <span class="text-red-500 text-xs ml-1">จำเป็นต้องกรอกข้อมูลนี้</span>
                </label>
                <textarea rows="4" v-model="formData.receiverAddress" disabled :readonly="isReadOnly"
                  class="w-full text-gray-700 border rounded px-3 py-2 resize-none">
            </textarea>
              </div>
              <div>
                <p v-if="formTouched && errors.receiverAddress" class="text-red-500 text-sm mt-1">{{
                  errors.receiverAddress }} </p>
              </div>

              <!-- <button class="mt-2 px-4 py-2 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700">
                              ตรวจสอบที่อยู่
                          </button> -->
            </div>
          </div>
        </div>

        <!-- ปุ่ม Show More / Show Less -->
        <!-- <button @click="showMoreAdress = !showMoreAdress" type="button"
                  class="mt-4 text-purple-600 hover:underline focus:outline-none">
                  {{ showMoreAdress ? 'แสดงน้อยลง ▲' : 'แสดงเพิ่มเติม ▼ ' }}
              </button> -->
        <div class="mt-4 flex items-center space-x-2">
          <button @click="showMoreAdress = !showMoreAdress" type="button"
            class="text-purple-600 hover:underline focus:outline-none">
            {{ showMoreAdress ? 'แสดงน้อยลง ▲' : 'แสดงเพิ่มเติม ▼ ' }}
          </button>

          <!-- ✅ เพิ่มข้อความแจ้งเตือนด้านข้างปุ่ม -->
          <span class="text-red-500 text-xs">*</span>
          <span class="text-red-500 text-xs">จำเป็นต้องกรอกข้อมูลนี้</span>
        </div>

      </div>

      <!-- ขวา: ข้อมูลการจัดส่งสินค้า -->
      <div>
        <div class="flex items-center gap-2 mb-4">
          <span class="material-icons text-purple-600">local_shipping</span>
          <h2 class="text-lg font-semibold text-gray-800">ข้อมูลการจัดส่งสินค้า</h2>
        </div>

        <div class="space-y-4">

          <div>
            <label class="block text-sm font-medium text-gray-700">วันที่จัดส่ง</label>

            <div class="relative">
              <!-- Flatpickr Input -->
              <flat-pickr v-model="formData.deliveryDate" :config="dateConfig" disabled :disabled="isReadOnly"
                class="cursor-pointer w-full text-gray-700 border rounded px-3 py-2"></flat-pickr>
              <!-- class="cursor-not-allowed pr-10 mt-1 pl-4 py-2 w-full border border-gray-300 rounded-lg shadow-sm focus:border-purple-500 focus:ring-purple-500 text-gray-700 placeholder-gray-400 bg-gray-100" /> -->

              <!-- Calendar Icon on the right -->
              <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
                style="padding-top: 0.2rem;">
                <span class="material-icons text-gray-400 text-base">calendar_today</span>
              </span>

            </div>

          </div>
          <p v-if="formTouched && errors.deliveryDate" class="text-red-500 text-sm mt-1">{{
            errors.deliveryDate }} </p>

          <div>
            <label class="text-sm text-gray-700 block mb-1">Tracking No.
              <span class="text-red-500 text-xs ml-1">*</span>
              <span class="text-red-500 text-xs ml-1">จำเป็นต้องกรอกข้อมูลนี้</span>
            </label>
            <input type="text" v-model="formData.trackingNo" disabled :readonly="isReadOnly"
              class="w-full text-gray-700 border rounded px-3 py-2" />
            <p v-if="formTouched && errors.trackingNo" class="text-red-500 text-sm mt-1">{{
              errors.trackingNo }} </p>
          </div>
        </div>
      </div>

    </div>

  </div>

  <div>
    <!-- Loading Overlay -->
    <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div class="text-center">
        <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
        </svg>
        <div class="mt-2 text-white text-lg">กำลังโหลดข้อมูล...</div>
      </div>
    </div>
    <!--  END Loading Overlay -->
  </div>

</template>


<script>
import { ref, onMounted, watch } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';
// import ProductSelector from '../components/ProductSelector.vue';
// import PromotionSelector from '../components/PromotionSelector.vue';
// import Promotion_ProductSelector from '../components/Promotion_ProductSelector.vue';
// import DeliveryAddressPopup from '@/components/DeliveryAddressPopup.vue'
// import ConfirmEditPopup from '@/components/saleOrder/ConfirmEditPopup.vue'
// import qs from 'qs';
import Flatpickr from 'vue-flatpickr-component'
import 'flatpickr/dist/flatpickr.css'

// ✅ import Thai locale
import { Thai } from 'flatpickr/dist/l10n/th.js'
import flatpickr from 'flatpickr'

// ✅ ตั้งค่าภาษาไทยให้กับ flatpickr
flatpickr.localize(Thai)

const BASE_URL = import.meta.env.VITE_API_URL;
const BASE_URL_LOCAL = import.meta.env.VITE_API_URL_LOCAL;

console.log('BASE_URL_LOCAL:', BASE_URL_LOCAL);

const BASE_URL_MAC_FIVEL = import.meta.env.VITE_API_URL_MAC_FIVELE;
const BASE_URL_AUTH = import.meta.env.VITE_API_URL_AUTH;
const BASE_URL_IMAGE = import.meta.env.VITE_API_URL_IMAGE;



export default {
  // name: 'SignupForm',
  components: {
    // ProductSelector,
    // PromotionSelector,
    // Promotion_ProductSelector,
    // DeliveryAddressPopup,
    'flat-pickr': Flatpickr,
    // ConfirmEditPopup
  },
  data() {
    return {

      currentDocumentNo: '', // แสดง document_no ใน breadcrumb

      // documentNo_route_params: route.params.id,
      documentNo_route_params: '', // ตั้งไว้ก่อน

      isLoading: false, // สำหรับ loading spinner

      isVatIncluded: true, //  เริ่มต้นให้คิดภาษี

      // ตัวแปรควบคุม popup
      showAddressPopup: false, // ควบคุมการแสดง popup ที่อยู่]

      //  เก็บข้อมูลที่อยู่ที่เลือกจาก popup
      selectedAddress: [],

      isConfirmed: false, // สำหรับควบคุมปุ่ม "ยืนยันการบันทึก"
      lockedDocumentNos: [], // เอกสารที่ถูกล็อก (เก็บใน LocalStorage หรือดึงจาก backend)

      errors: {}, // เก็บข้อผิดพลาดของฟอร์ม
      formTouched: false, // ค่าเริ่มต้น

      customerData: JSON.parse(localStorage.getItem('selectDataCustomer') || 'null'),

      BASE_URL_IMAGE: import.meta.env.VITE_API_URL_IMAGE,

      isReadOnly: false, // ใช้ควบคุมสถานะ readonly

      selectedDate: '',
      // ✅ ตั้งค่ารูปแบบวันและปฏิทิน
      dateConfig: {
        dateFormat: 'd/m/Y', // เช่น 01/07/2568
        // dateFormat: 'Y-m-d',
        locale: Thai, // ใช้ภาษาไทย
        // disabledMobile: true, // ปิดการเลื่อนเดือน
      },

      showMore: false, // ค่าเริ่มต้น

      showProductSelector: false,
      showPromotionSelector: false,
      showProductSelectoronly: false,

      showPromotionProductSelector: false,
      selectedPromotion: [],

      showConfirmEditPopup: false,
      popupFormData: [],

      Apiproducts: [], // เก็บข้อมูลสินค้าที่ได้จาก API

      pageSize: 30, // ค่าเริ่มต้น
      totalItems: 0, // ค่าเริ่มต้น

      showMoreData: false, // ค่าเริ่มต้น
      showMoreAdress: false, // ค่าเริ่มต้น

      isDropdownOpen: false, // ควบคุมการเปิด/ปิด Dropdown

      formData: {
        listCode: '',
        sellDate: '',
        // sellDate: new Date().toISOString().split('T')[0], // ตั้งค่าเริ่มต้นเป็นวันที่ปัจจุบัน (YYYY-MM-DD)
        // sellDate: new Date().toLocaleDateString('th-TH', {
        //     day: '2-digit',
        //     month: '2-digit',
        //     year: 'numeric',
        // }), // ตั้งค่าเริ่มต้นเป็นวันที่ปัจจุบันในรูปแบบ วัน/เดือน/ปี
        sellDate: new Date(),        // ✅ ใช้ Date object ตรง ๆ
        deliveryDate: new Date(),    // ✅ ใช้ Date object ตรง ๆ
        // expireDate: '',
        reference: '' || '-',
        channel: '' || '-',
        taxType: '' || '-',

        fullName: '',
        customerCode: '',
        phone: '',
        email: '' || '-',
        address: '',
        receiverName: '',
        receiverPhone: '' || '-',
        receiverEmail: '' || '-',
        receiverAddress: '',
        note: '' || '-',

        promotions: [], // เก็บรายการสินค้าที่เลือก
        gifts: [], // เก็บรายการของแถม

        // ใช้
        // deliveryDate: '',

        trackingNo: '',
        deliveryType: '',
        totalDiscount: '',

        totalDiscount: '',
        deliveryFee: '',

        documentNo: '',

        pro_quantity: '' || 0,

        discount: '' || 0,

        // ... ของเดิมทั้งหมด
        price_before_tax: 0,
        tax_value: 0,
        price_with_tax: 0,
        // ... ต่อไป

        final_total_price: 0,

        // total_price: '' || 0,

        // product_name : product.pro_name,
        // qty: '',
        pro_erp_title: '',
        // pro_name: '',

        productList: [],

        warehouseCode: 'H1',
        docType: 'SO',
      },

      //form ที่โหลดมาตั้งต้นเพื่อเปรียบเทียบค่าว่ามีการเปลี่ยนแปลงก่อนอัปเดทไหม 
      originalFormData: {},
      originalSelectedProducts: [],

      selectedProducts: [], // ค่าเริ่มต้นเป็น array ว่าง

      allSelectedPromotionProducts: [], // 🔁 รวมสินค้าที่เคยเลือกทั้งหมด
    };
  },

  mounted() {

    const docNo = this.$route.params.id;

    this.documentNo_route_params = docNo;
    // ดึงค่าจาก URL param
    this.currentDocumentNo = `Sale Order: ${docNo}`;
    // loadDataDocument
    this.loadDocumentData(this.documentNo_route_params);
  },

  watch: {

    isVatIncluded(newVal) {
      this.formData.taxType = newVal ? 'รวมภาษี' : 'ไม่รวมภาษี'
    },

  },

  computed: {

    totalAmountBeforeDiscount() {
      const subtotal = this.selectedProducts.reduce((sum, product) => {
        const qty = product.pro_quantity || 0;
        const price = product.pro_unit_price || 0;
        const discount = product.discount || 0;
        return sum + (qty * price - discount);
      }, 0);
      const deliveryFee = parseFloat(this.formData.deliveryFee) || 0;
      const totalDiscount = parseFloat(this.formData.totalDiscount) || 0;
      const total = subtotal + deliveryFee - totalDiscount;
      return total < 0 ? 0 : total;
    },
    grandTotal() {
      const netBeforeVat = this.totalAmountBeforeDiscount;
      const vat = this.isVatIncluded ? netBeforeVat * 0.07 : 0;
      return (netBeforeVat + vat).toFixed(2);
    },
    // ตรวจสอบว่าเป็นหน้าแก้ไขหรือสร้างใหม่
    isCreatePage() {
      return this.$route.path === '/createsalelist'
    },
    visibleButtons() {
      const buttons = []
      if (this.isReadOnly) buttons.push('edit')
      if (!this.isReadOnly && this.isCreatePage) buttons.push('save')
      if (!this.isReadOnly && this.formData.documentNo && !this.isCreatePage) buttons.push('update')
      return buttons

    },


  },

  methods: {

    async loadDocumentData(documentNo_route_params) {
      try {
        this.isLoading = true;

        const response = await axios.get(`${BASE_URL_LOCAL}/api_admin_dashboard/backend/api/sale_order/get_sale_order.php?documentNo=${documentNo_route_params}`);

        console.log("😂 Log Value response: ", response);

        const resData = response.data;

        console.log("😂 Log Value resData: ", resData.data);

        if (resData.success) {
          // เติมข้อมูลลงใน formData โดยรักษาฟิลด์ที่ไม่ได้อยู่ใน API
          this.formData = {
            ...this.formData, // เก็บค่าฟิลด์เดิมที่ไม่ได้อยู่ใน API
            listCode: resData.data.order.list_code || '',
            sellDate: resData.data.order.sell_date || '',
            reference: resData.data.order.reference || '',
            channel: resData.data.order.channel || '',
            taxType: resData.data.order.tax_type || '',
            fullName: resData.data.order.full_name || '',
            customerCode: resData.data.order.customer_code || '',
            phone: resData.data.order.phone || '',
            email: resData.data.order.email || '',
            address: resData.data.order.address || '',
            receiverName: resData.data.order.receiver_name || '',
            receiverPhone: resData.data.order.receiver_phone || '',
            receiverEmail: resData.data.order.receiver_email || '',
            receiverAddress: resData.data.order.receiver_address || '',
            note: resData.data.order.note || '',
            deliveryDate: resData.data.order.delivery_date || '',
            trackingNo: resData.data.order.tracking_no || '',
            deliveryType: resData.data.order.delivery_type || '',
            totalDiscount: resData.data.order.total_discount || 0,
            deliveryFee: resData.data.order.delivery_fee || 0,
            final_total_price: resData.data.order.final_total_price || 0,
            documentNo: resData.data.order.document_no || '',

            //
            promotions: resData.data.promotions || [],
            gifts: resData.data.gifts || []

          };

          console.log("📄 ข้อมูลเอกสารที่โหลด:", resData.data.productList);
          console.log("🔍 ก่อน map this.selectedProducts:", this.selectedProducts);


          this.selectedProducts = resData.data.productList.map(product => {

            console.log("🛠️ กำลัง map product:", product); // 👈 log ตรงนี้เช็กแต่ละตัว
            const productObj = {
              item_id: product.id,
              pro_id: product.pro_id,
              pro_erp_title: product.pro_name,
              pro_quantity: product.qty,
              pro_unit_price: parseFloat(product.unit_price),
              pro_discount: parseFloat(product.discount),
              pro_total_price: parseFloat(product.total_price),
              pro_images: product.pro_images,
              pro_sn: product.sn,
              pro_unit: product.unit || '',
              activity_id: product.pro_activity_id || null,
              pro_activity_id: product.pro_activity_id || 0, // ✅ ใช้ชื่อนี้ให้ตรง backend
              pro_goods_sku_text: product.pro_goods_sku_text || '',
              // promotions: matchedPromotions,
              // gifts: matchedGifts
              // ✅ ดึงจาก product โดยตรง
              promotions: product.promotions || [],
              gifts: product.gifts || []
            };

            console.log("🎁 productObj:", productObj); // <--- สำคัญ
            return productObj;

          });

          console.log("📄 ข้อมูลเอกสารที่โหลด:", this.formData);
          console.log("🛒 รายการสินค้า:", this.selectedProducts)

          // ยังไม่ใช้
          this.originalFormData = JSON.parse(JSON.stringify(this.formData)); // deep copy
          this.originalSelectedProducts = JSON.parse(JSON.stringify(this.selectedProducts));


          this.isLoading = false;
          ;
        } else {
          Swal.fire({ text: resData.message, icon: 'error' });
        }
      } catch (err) {
        const message = err.response?.data?.message || err.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูลเอกสาร';
        Swal.fire({ text: message, icon: 'error' });
      }
    },

    groupByActivityId(products) {
      return products.reduce((acc, item) => {
        const key = `${item.activity_id || 'no-activity'}-st${item.st ?? 0}`;
        if (!acc[key]) acc[key] = [];
        acc[key].push(item);
        return acc;
      }, {});
    },

    totalprice(product) {
      // const qty = product.qty || 0;
      // const price = product.pro_unit_price || 0;
      // const discount = product.discount || 0;
      // const totalprice = (qty * price - discount).toFixed(2);
      // console.log('Log value:', totalprice);
      // return totalprice;
      const qty = product.pro_quantity || 0; // ใช้ pro_quantity แทน qty
      const price = product.pro_unit_price || 0;
      const discount = product.discount || 0;
      const totalprice = (qty * price - discount).toFixed(2);
      console.log('Log value:', totalprice);
      return totalprice;
    },

    toggleShowMoreData() {
      this.showMoreData = !this.showMoreData;
      console.log("😵‍💫😵‍💫 showMoreData:", this.showMoreData);
    },


    saveDocument() {
      try {
        this.isLoading = true;

        console.log('Approve new document')

        // const isValid = await this.validateForm();
        // const isValid = this.isValid;
        // if (!isValid) {
        //   console.warn("❌ ข้อมูลไม่ครบ", this.errors);
        //   Swal.fire({
        //     icon: 'error',
        //     title: 'ไม่สามารถบันทึกได้',
        //     text: 'กรุณากรอกข้อมูลให้ครบถ้วน',
        //   });
        //   return;
        // }

        Swal.fire({
          icon: 'success',
          title: 'อนุมัติเอกสารสำเร็จ',
          text: 'อนุมัติเอกสารเรียบร้อย',
        });


        // ✅ ดำเนินการบันทึกต่อ...
        console.log("✅ อนุมัติเอกสารเรียบร้อย");

        this.isLoading = false;
      } catch (err) {
        const message = err.response?.data?.message || err.message || 'Unknown error';
        Swal.fire({ text: message, icon: 'error' });
        console.log('a454545654564 catch');
      }
    }

  },

}


</script>

<!-- <template>
    <div class="p-6">
      <h2 class="text-xl font-semibold mb-4">รายละเอียดคำสั่งซื้อ ID: {{ orderId }}</h2>
  
      <div v-if="orderDetail" class="space-y-2 bg-white p-4 rounded shadow">
        <p><strong>ชื่อร้าน:</strong> {{ orderDetail.shop_name }}</p>
        <p><strong>รหัสลูกค้า:</strong> {{ orderDetail.customer_code }}</p>
        <p><strong>เบอร์โทร:</strong> {{ orderDetail.mobile }}</p>
        <p><strong>ยอดสั่งซื้อ:</strong> {{ formatCurrency(orderDetail.total_amount) }}</p>
        <p><strong>สถานะ:</strong> {{ orderDetail.status }}</p>
        <p><strong>วันที่สร้าง:</strong> {{ orderDetail.created_at }}</p>
  
        <!-- รายการสินค้า 
        <div class="mt-4">
          <h3 class="font-semibold mb-2">สินค้าในคำสั่งซื้อ</h3>
          <ul class="list-disc list-inside">
            <li v-for="item in orderDetail.items" :key="item.id">
              {{ item.pro_name }} - {{ item.qty }} ชิ้น
            </li>
          </ul>
        </div>
      </div>
  
      <div v-else class="text-gray-500">กำลังโหลดข้อมูล...</div>
    </div>
  </template> -->

<!-- <script setup>
  import { ref, onMounted } from 'vue'
  import { useRoute } from 'vue-router'
  import axios from 'axios'
  
  const route = useRoute()
  const orderId = route.params.id
  const BASE_URL = import.meta.env.VITE_API_URL
  
  const orderDetail = ref(null)
  
  const formatCurrency = (value) =>
    Number(value).toLocaleString(undefined, {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    })
  
  onMounted(async () => {
    try {
      const res = await axios.get(`${BASE_URL}/api_admin_dashboard/backend/api/get_sale_order_detail.php?id=${orderId}`)
      orderDetail.value = res.data
    } catch (err) {
      console.error('❌ Load detail failed:', err)
    }
  })
  </script> -->