<template>
  <div class="p-4 relative">
    <h1 class="text-2xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>

    <!-- ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <div class="mb-4">
      <input
        v-model="searchQuery"
        type="text"
        placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ / ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"
        class="w-full border border-gray-300 rounded-md px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô-->
    <!-- <transition name="slide-button">
      <button
        v-if="showAnimatedButton"
        @click="scrollToRight"
        class="fixed top-20 right-4 z-50 px-4 py-2 bg-blue-600 text-white rounded shadow-lg hover:bg-blue-700 transition"
        title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
      >
        ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° {{ isScrolledRight ? "‚óÄ" : "‚ñ∂" }}
      </button>
    </transition> -->

    <transition name="slide-button">
      <button
        v-if="showAnimatedButton"
        @click="scrollToRight"
        class="fixed top-20 right-4 z-50 flex items-center gap-2 px-5 py-3 bg-yellow-400 text-white rounded-lg shadow-lg hover:bg-yellow-700 transition duration-300 ease-in-out max-[480px]:px-1 max-[480px]:py-2 max-[480px]:text-sm max-[480px]:gap-1"
        title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
      >
        <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
        <svg
          class="w-5 h-5 text-white"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
          />
        </svg>

        <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
        <span class="font-medium"> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° {{ isScrolledRight ? "‚óÄ" : "‚ñ∂" }} </span>
      </button>
    </transition>

    <!-- <table class="min-w-full || [1500px] text-sm text-left text-gray-700 divide-x divide-gray-200"> -->
    <div
      ref="tableWrapper"
      style="max-width: 100%"
      class="overflow-auto rounded-lg shadow-md"
      @scroll="onScroll"
    >
      <table
        class="min-w-[1500px] table-fixed text-sm text-left text-gray-700 divide-x divide-gray-200 border border-gray-300"
      >
        <thead class="bg-gray-100 text-xs uppercase border">
          <tr class="border-r border-gray-300">
            <th class="p-3 border">Id</th>
            <th class="p-3 border">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th class="p-3 border">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th class="p-3 border">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</th>
            <th class="p-3 border">‡∏û‡∏ô‡∏á.‡πÄ‡∏£‡πà‡∏á‡∏£‡∏±‡∏î</th>
            <th class="p-3 border">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
            <th class="p-3 border text-right">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
            <th class="p-3 border text-right">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</th>
            <th class="p-3 border">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
            <th class="p-3 border">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (days)</th>
            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
            <th class="p-3 border">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô (limit)</th>
            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
            <th class="p-3 border">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ (Sales)</th>
            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
            <th class="p-3 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡∏µ‡πâ</th>
            <th class="p-3 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
            <th class="p-3 border">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
            <!-- <th class="p-3 border">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th> -->

            <!-- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô crm ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ -->
            <th v-if="!isCrm" class="p-3 border">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
          </tr>
        </thead>

        <tbody v-if="isLoading">
          <tr>
            <td colspan="11" class="py-10 text-center">
              <svg
                class="animate-spin h-8 w-8 text-blue-600 mx-auto"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
              </svg>
              <div class="mt-2 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            </td>
          </tr>
        </tbody>

        <tbody v-if="!isLoading" class="text-xs">
          <template v-for="order in filteredOrders" :key="order.id">
            <!-- divide-x divide-gray-200 -->
            <tr class="border-b hover:bg-gray-50">
              <!-- <tr v-for="order in filteredOrders" :key="order.id" class="border-b hover:bg-gray-50"> -->
              <!-- <tr v-for="order in saleOrders" :key="order.id" class="border-b hover:bg-gray-50"> -->
              <td class="p-3">{{ order.id }}</td>
              <td class="p-3">{{ order.sale_no }}</td>
              <td class="p-3">{{ order.customer_code }}</td>
              <td class="p-3">{{ order.shop_name }}</td>
              <!-- <td class="p-3">{{ order.shop_name }}</td> -->
              <td class="p-3">{{ order.employee_name ? order.employee_name : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</td>
              <td class="p-3">{{ order.mobile }}</td>
              <td class="p-3 text-right">{{ formatCurrency(order.total_amount) }}</td>
              <td class="p-3 text-right">{{ formatCurrency(order.total_paid) }}</td>
              <td class="p-3">{{ order.created_at }}</td>

              <td class="p-3">
                {{ order.deBcreditTerm ? order.deBcreditTerm : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏´‡∏ô‡∏î" }}
              </td>
              <td class="p-3">
                {{
                  !order.deBlimit || isNaN(order.deBlimit)
                    ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô"
                    : formatCurrency(order.deBlimit)
                }}
              </td>
              <td class="p-3">{{ order.deBsalesP ? order.deBsalesP : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</td>
              <!-- <td class="p-3">{{ order.status2 ? order.status2: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' }}</td> -->
              <td
                :class="[
                  'p-3',
                  getStatusColor(getHighestStatus(filteredExtraDetails(order))),
                  'w-[9rem]', // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô 12rem (48 * 0.25rem)
                  'max-w-xs', // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î max-width ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î
                  'break-words', // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
                  'border-t-2 border-b-2 border-gray-300', // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á
                ]"
              >
                {{ getDisplayStatus(getHighestStatus(filteredExtraDetails(order))) }}
              </td>

              <td class="p-3">
                <!-- :class="order.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? 'bg-gray-500' : 'bg-green-500'" -->
                <span class="flex items-center space-x-1">
                  <span
                    class="w-2 h-2 rounded-full"
                    :class="{
                      'bg-gray-500': order.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
                      'bg-green-500': order.status === '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                      'bg-red-500': order.status === '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                    }"
                  ></span>
                  <span class="w-[90px]">{{ order.status }}</span>
                </span>
              </td>

              <!-- ‡∏õ‡∏∏‡πà‡∏° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö -->
              <td class="p-3">
                <router-link :to="{ name: 'saleorderdetail', params: { id: order.sale_no } }">
                  <button
                    class="w-24 px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                  >
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                  </button>
                </router-link>
              </td>

              <!-- ‡∏õ‡∏∏‡πà‡∏° ‡∏•‡∏ö (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà canApprove ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) -->
              <td class="p-3" v-if="canApprove">
                <button
                  @click="confirmDelete(order.id)"
                  class="w-24 px-4 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                >
                  ‡∏•‡∏ö
                </button>
              </td>

              <!-- ‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà canEdit ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) -->
              <!-- <td class="p-3" v-if="canEdit">
                <button
                  @click="enableEditMode(order.id)"
                  class="w-24 px-4 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"
                >
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
              </td> -->
            </tr>

            <!-- ‚úÖ ‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏ß‡∏á) -->
            <!-- <tr v-if="order.extra_details" class="bg-blue-50"> -->
            <!-- <td colspan="11" class="p-4 text-sm text-gray-700 border"> -->
            <!-- ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠ card ‡πÑ‡∏î‡πâ -->
            <!-- <div>
                  <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong>
                  <ul class="list-disc ml-6 mt-2">
                    <li v-for="(item, index) in order.extra_details" :key="index">{{ item }}</li>
                  </ul>
                </div>
              </td>
            </tr> -->
            <!-- ‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
            <!-- <tr v-if="order.extra_details.length" class="bg-blue-50"> -->

            <tr
              v-if="filteredExtraDetails(order).length > 0"
              class="bg-blue-50 hover:bg-blue-100 transition-colors duration-300"
            >
              <td colspan="16" class="px-6 py-4 border rounded-md">
                <div class="flex items-center space-x-2 text-blue-800 font-medium mb-3">
                  <svg
                    class="w-5 h-5 text-blue-600"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M13 16h-1v-4h-1m2-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</span>
                </div>

                <!-- Cards style -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                  <div
                    v-for="(d, i) in filteredExtraDetails(order)"
                    :key="i"
                    class="flex justify-between items-center bg-white shadow-sm rounded-lg p-4 border border-gray-200 transition-transform transform hover:scale-[1.015] hover:shadow-md duration-300"
                  >
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ -->
                    <div class="text-sm text-gray-800">
                      <div class="text-[13px]">
                        <strong class="text-[13px]">Invoice No.:</strong> {{ d.miHvnos }}
                      </div>
                      <div class="text-[13px]">
                        <strong class="text-[13px]">Due Date:</strong> {{ d.dueDate }}
                      </div>
                      <div class="text-[13px]">
                        <strong class="text-[13px]">Overdue Days:</strong> {{ d.overdueDays }}
                      </div>
                      <div class="text-[13px]">
                        <strong class="text-[13px]">Status:</strong>
                        {{ getDisplayStatus(d.status2) }}
                      </div>
                      <div class="text-[13px]">
                        <strong class="text-[13px]">Status:</strong> {{ d.status2 }}
                      </div>
                      <div class="text-[13px]">
                        <strong class="text-[13px]">Amount Due:</strong>
                        {{ formatCurrency(d.inInvAmount) }}
                      </div>
                    </div>

                    <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ -->
                    <!-- <div class="w-14 h-14 flex items-center justify-center rounded-full shadow-inner"
                      :class="getStatusColor(d.status2)" title="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ getDisplayStatus(d.status2) }}">
                      <component :is="getStatusIcon(d.status2)" class="w-6 h-6" />
                    </div> -->
                    <div class="relative group z-50">
                      <div
                        class="w-14 h-14 flex cursor-pointer items-center justify-center rounded-full shadow-inner transition-transform transform group-hover:scale-105"
                        :class="getStatusColor(d.status2)"
                      >
                        <component :is="getStatusIcon(d.status2)" class="w-6 h-6" />
                      </div>
                      <div
                        class="absolute -top-2 left-1/2 -translate-x-1/2 -translate-y-full bg-black text-white text-xs px-3 py-1 rounded-md opacity-0 group-hover:opacity-100 group-hover:-translate-y-[130%] transition-all duration-300 whitespace-nowrap z-60"
                      >
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ d.status2 }}
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- pagination -->
    <!-- pagination -->
    <div
      class="flex flex-col sm:flex-row sm:justify-between sm:items-center mt-4 gap-2 sm:gap-0 text-sm sm:text-base"
    >
      <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
      <span class="text-center sm:text-left text-xs">
        Showing {{ filteredOrders.length }} of {{ totalRows }} rows
      </span>

      <!-- ‡∏õ‡∏∏‡πà‡∏° pagination -->
      <div class="flex justify-center sm:justify-end items-center space-x-2">
        <button
          :disabled="currentPage === 1"
          @click="goToPage(currentPage - 1)"
          class="px-3 py-1 bg-gray-200 text-ms rounded disabled:opacity-50"
        >
          Prev
        </button>

        <span class="mx-1">‡∏´‡∏ô‡πâ‡∏≤ </span>
        <span class="mx-1"> {{ currentPage }} / {{ totalPages }}</span>

        <button
          :disabled="currentPage === totalPages"
          @click="goToPage(currentPage + 1)"
          class="px-3 py-1 bg-gray-200 text-ms rounded disabled:opacity-50"
        >
          Next
        </button>
      </div>
    </div>

    <!-- pagination -->
    <!-- <div class="flex justify-between items-center mt-4"> -->
    <!-- <span>Showing {{ saleOrders.length }} of {{ totalRows }} rows</span> -->
    <!-- <span>Showing {{ filteredOrders.length }} of {{ totalRows }} rows</span> -->
    <!-- Pagination UI -->
    <!-- ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° Tailwind pagination component ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
    <!-- </div> -->
  </div>
</template>

<script setup>
import { ref, onMounted, computed, watch} from "vue";
// , reactive
import axios from "axios";
// import { logActivity } from '@/services/activityLogger.js'
import Swal from "sweetalert2";
import {
  CheckCircleIcon,
  AlertTriangleIcon,
  AlertOctagonIcon,
  XOctagonIcon,
  BanIcon,
  HelpCircleIcon,
} from "lucide-vue-next";

// import { eventBus } from '@/utils/eventBus'

// import { Message } from 'tdesign-vue-next'

// const BASE_URL_LOCAL = import.meta.env.VITE_API_URL_LOCAL;

// const BASE_URL = import.meta.env.VITE_API_URL
const VITE_API_URL_C_SHARP = import.meta.env.VITE_API_URL_C_SHARP;
const BASE_URL_LOCAL = import.meta.env.VITE_API_URL_LOCAL;

const tableWrapper = ref(null);
const noticeBox = ref(null);
const showNotice = ref(false);
const isScrolledRight = ref(false); // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏ß‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
const showAnimatedButton = ref(false);

const saleOrders = ref([]);

const totalRows = ref(0);
const currentPage = ref(1);
const limit = 10;

const searchQuery = ref(""); // <- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
const isLoading = ref(false); // ‡∏´‡∏£‡∏∑‡∏≠ true ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á

const isAdmin = computed(() => localStorage.getItem("role_admin") === "true");
const isFa = computed(() => localStorage.getItem("role_fa") === "true");
const isCrm = computed(() => localStorage.getItem("role_crm") === "true");

const canApprove = computed(() => isFa.value || isAdmin.value);
// const canEdit = computed(() => isCrm.value || isAdmin.value);

const statusPriority = {
  ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: 1,
  ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: 2,
  ‡∏™‡πâ‡∏°: 3,
  ‡πÅ‡∏î‡∏á: 4,
  ‡∏î‡∏≥: 5,
  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: 0,
  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: 6,
};

const formatCurrency = (value) =>
  Number(value).toLocaleString(undefined, {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });

// const getDisplayStatus = (status) => {
//   switch (status) {
//     case '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢': return '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏±‡∏ô'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
//     case '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö': return '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏±‡∏ô'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
//     case '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß': return '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ 120 ‡∏ß‡∏±‡∏ô'; // ‡πÅ‡∏î‡∏á
//     case '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö': return '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ 180 ‡∏ß‡∏±‡∏ô'; // ‡∏î‡∏≥
//     case '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠': return '‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
//     default: return status;
//   }
// }

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ component ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° animation
onMounted(() => {
  showAnimatedButton.value = true;

  // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  setTimeout(() => {
    showAnimatedButton.value = false;
  }, 10000);
});

function scrollToRight() {
  if (!tableWrapper.value) return;

  if (!isScrolledRight.value) {
    // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î
    tableWrapper.value.scrollTo({
      left: tableWrapper.value.scrollWidth,
      behavior: "smooth",
    });
    isScrolledRight.value = true;
  } else {
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏ß‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
    tableWrapper.value.scrollTo({
      left: 0,
      behavior: "smooth",
    });
    isScrolledRight.value = false;
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (optional)
  showNotice.value = true;
  setTimeout(() => {
    showNotice.value = false;
  }, 3000);
}

function onScroll() {
  if (!tableWrapper.value || !noticeBox.value) return;

  const scrollLeft = tableWrapper.value.scrollLeft;
  // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡∏ï‡∏≤‡∏° scrollLeft ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô container width - notice width
  const maxTranslateX = tableWrapper.value.clientWidth - noticeBox.value.offsetWidth;

  // -scrollLeft ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏ï‡πà scroll ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤ => ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
  let translateX = -scrollLeft;

  if (translateX < -maxTranslateX) translateX = -maxTranslateX;
  if (translateX > 0) translateX = 0;
}

const getDisplayStatus = (status) => {
  switch (status) {
    case "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß":
      return "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏±‡∏ô";
    case "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á":
      return "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏±‡∏ô";
    case "‡∏™‡πâ‡∏°":
      return "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏±‡∏ô";
    case "‡πÅ‡∏î‡∏á":
      return "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ 120 ‡∏ß‡∏±‡∏ô";
    case "‡∏î‡∏≥":
      return "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ 180 ‡∏ß‡∏±‡∏ô";
    case "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞":
      return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
    case "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠":
      return "‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
    default:
      return status || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
  }
};

const getStatusColor = (status) => {
  switch (status) {
    case "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß":
      return "bg-green-100 text-green-800";
    case "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á":
      return "bg-yellow-100 text-yellow-800";
    case "‡∏™‡πâ‡∏°":
      return "bg-orange-100 text-orange-800";
    case "‡πÅ‡∏î‡∏á":
      return "bg-red-100 text-red-800";
    case "‡∏î‡∏≥":
      return "bg-gray-800 text-white";
    case "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞":
      return "bg-gray-200 text-gray-600";
    case "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠":
      return "bg-gray-300 text-gray-700 italic";
    default:
      return "bg-gray-100 text-gray-500";
  }
};

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° icon ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
const getStatusIcon = (status) => {
  switch (status) {
    case "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß":
      return CheckCircleIcon;
    case "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á":
      return AlertTriangleIcon;
    case "‡∏™‡πâ‡∏°":
      return AlertTriangleIcon;
    case "‡πÅ‡∏î‡∏á":
      return AlertOctagonIcon;
    case "‡∏î‡∏≥":
      return XOctagonIcon;
    case "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠":
      return BanIcon;
    default:
      return HelpCircleIcon;
  }
};

const getHighestStatus = (details) => {
  if (!details || details.length === 0) return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";

  return details.reduce((highest, current) => {
    const currentPriority = statusPriority[current.status2] ?? 0;
    const highestPriority = statusPriority[highest] ?? 0;
    return currentPriority > highestPriority ? current.status2 : highest;
  }, "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
};

const filteredOrders = computed(() => {
  const raw = searchQuery.value.trim();
  if (!raw) return saleOrders.value;

  const keyword = raw.toLowerCase();
  const parts = keyword.split(/\s+/); // ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á

  return saleOrders.value.filter((order) => {
    const saleNo = order.sale_no?.toLowerCase().trim() || "";
    const customerCode = order.customer_code?.toLowerCase().trim() || "";
    const shopName = order.shop_name?.toLowerCase().trim() || "";
    const mobile = order.mobile?.toLowerCase().trim() || "";
    const createdAt = order.created_at?.toLowerCase().trim() || "";

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡∏•‡∏∞ keyword
    return parts.every((part) => {
      const isoDate = convertThaiDateToISO(part);
      return (
        saleNo.includes(part) ||
        customerCode.includes(part) ||
        shopName.includes(part) ||
        mobile.includes(part) ||
        (isoDate && createdAt.includes(isoDate)) ||
        createdAt.includes(part) // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ user ‡∏û‡∏¥‡∏°‡∏û‡πå yyyy-mm-dd ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
      );
    });
  });
});

function convertThaiDateToISO(dateStr) {
  const parts = dateStr.trim().split(/[-/]/);
  if (parts.length !== 3) return null;

  let [day, month, year] = parts.map((p) => parseInt(p, 10));

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  if (isNaN(day) || isNaN(month) || isNaN(year)) return null;

  if (year > 2400) year -= 543;

  const dateObj = new Date(year, month - 1, day);

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô valid date
  if (isNaN(dateObj.getTime())) return null;

  return dateObj.toISOString().split("T")[0]; // yyyy-mm-dd
}

async function confirmDelete(orderId) {
  console.log("Check orderId: ", orderId);

  const result = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö",
    text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
  });

  // return;

  if (result.isConfirmed) {
    try {
      const res = await axios.post(
        `${BASE_URL_LOCAL}/api_admin_dashboard/backend/api/list_sale_orders/delete_order.php`,
        { orderId },
        {
          headers: {
            "Content-Type": "application/json",
          },
        }
      );

      if (res.data.success) {
        Swal.fire("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", res.data.message, "success");
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        await fetchPage(currentPage.value);
      } else {
        Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", res.data.message || "‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
      }
    } catch (error) {
      Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error");
    }
  }
}

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
// async function fetchPage(page = 1) {
//   isLoading.value = true;
//   try {
//     // ${BASE_URL}
//     const res = await axios.get(
//       `${BASE_URL}/api_admin_dashboard/backend/api/list_sale_orders/get_list_sale_order.php?v=${Date.now()}`,
//       { params: { page, limit } }
//     );

//     console.log("Check Log res :", res);

//     if (res.data.success) {
//       // console.log('Check Log res.data :',res.data);
//       saleOrders.value = res.data.data.list_order.map((item) => ({
//         id: item.id,
//         sale_no: item.document_no,
//         customer_code: item.customer_code,
//         shop_name: item.full_name,
//         mobile: item.phone,
//         total_amount: item.final_total_price,
//         total_paid: item.final_total_price,
//         status: item.status,
//         created_at: item.created_at,
//         // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á mock data
//         extra_details: item.extra_list || [
//           `‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${item.id}-A`,
//           `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.final_total_price}`,
//           `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${item.status}`,
//           // `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß`
//         ],
//       }));

//       console.log("Check Log saleOrders.value :", saleOrders.value);

//       totalRows.value = res.data.data.total;
//       currentPage.value = page;

//       // await logActivity(' user ‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ SaleOrderList', 'SaleOrderList.vue');
//       // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ TypeCustomers ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à
//       await TypeCustomers();
//     }
//   } catch (e) {
//     console.error(e);
//   } finally {
//     isLoading.value = false;
//   }
// }

async function fetchPage(page = 1) {
  isLoading.value = true;
  try {
    const res = await axios.get(
      `${BASE_URL_LOCAL}/api_admin_dashboard/backend/api/list_sale_orders/get_list_sale_order.php?v=${Date.now()}`,
      {
        params: {
          page,
          limit,
          search: searchQuery.value.trim(),
        },
      }
    );

    console.log("Check Log res :", res);

    if (res.data.success) {
      saleOrders.value = res.data.data.list_order.map((item) => ({
        id: item.id,
        sale_no: item.document_no,
        customer_code: item.customer_code,
        shop_name: item.full_name,
        mobile: item.phone,
        total_amount: item.final_total_price,
        total_paid: item.final_total_price,
        status: item.status,
        created_at: item.created_at,
        employee_name: item.employee_name, //
        employee_phone: item.employee_phone, // ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ
        extra_details: item.extra_list || [],
      }));

      totalRows.value = res.data.data.total;
      currentPage.value = page;

      // // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Order ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
      // const pendingCount = saleOrders.value.filter(o => o.status !== '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢').length;

      // // ‚úÖ ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ Navbar ‡∏ú‡πà‡∏≤‡∏ô eventBus
      // eventBus.emit('updateOrderNotification', pendingCount);

      // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ TypeCustomers ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à
      await TypeCustomers();
    }
  } catch (e) {
    console.error(e);
  } finally {
    isLoading.value = false;
  }
}

//
async function getTokenDebtStatusType() {
  isLoading.value = true;

  // const payload = {
  //   username: "DPower1",
  //   password: "1234"
  // }

  // console.log('Log payload: ', payload);

  try {
    const loginData = {
      username: "DPower1",
      password: "1234",
    };

    //fetch ‡πÉ‡∏ä‡πâ await res.json() ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏à‡∏∞‡πÑ‡∏î‡πâ Promise
    // const res = await fetch('https://203.154.60.148:58915/api/Users/Login', {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json'
    //   },
    //   body: JSON.stringify(loginData),
    //   mode: 'cors'
    // });

    // const data = await res.json();.

    const res = await axios.post(
      `${VITE_API_URL_C_SHARP}/api/Users/Login?v=${Date.now()}`,
      loginData,
      {
        headers: {
          "Content-Type": "application/json",
        },
      }
    );

    const data = res.data;

    console.log("Check Log data :", data);
    console.log("Check Log data.token :", data.token);

    const tokenDebtStatusType = data.token;
    console.log("Check Log res.tokenDebtStatusType :", tokenDebtStatusType);

    if (tokenDebtStatusType) {
      localStorage.setItem("tokenDebtStatusType", tokenDebtStatusType);
      isLoading.value = false;
      return tokenDebtStatusType;
    } else {
      console.warn("‚ö†Ô∏è Token not found in response.");
      return null;
    }
  } catch (e) {
    console.error(e);
  } finally {
    isLoading.value = false;
  }
}

async function TypeCustomers() {
  isLoading.value = true;

  // üîÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡∏à‡∏≤‡∏Å saleOrders
  const payload = saleOrders.value.map((item) => ({
    CustomerDocument: item.sale_no,
    CustomerCode: item.customer_code,
  }));

  console.log(" payload: ", payload);

  const tokendebtStatusType = await getTokenDebtStatusType();

  // const tokendebtStatusType = await getTokenDebtStatusType();
  console.log("üîë tokendebtStatusType: ", tokendebtStatusType);

  if (!tokendebtStatusType) {
    console.error("‚ùå No token available. Cannot call TypeCustomers API.");
    isLoading.value = false;
    return;
  }

  try {
    // VITE_API_URL_C_SHARP
    const res = await axios.post(
      `${VITE_API_URL_C_SHARP}/api/TypeCustomers?v=${Date.now()}`,
      payload,
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${tokendebtStatusType}`,
        },
      }
    );

    const data = res.data;

    console.log("‚úÖ Response from TypeCustomers:", data);

    if (data && Array.isArray(data)) {
      // 1) group by sale_no/customerDocument
      const grouped = {};
      data.forEach((item) => {
        const key = item.customerDocument;
        if (!grouped[key]) {
          grouped[key] = {
            deBcreditTerm: item.deBcreditTerm,
            deBlimit: item.deBlimit,
            deBsalesP: item.deBsalesP,
            status2: item.status2,
            total_paid: 0,
            extra_details: [],
          };
        }
        grouped[key].total_paid += item.inInvAmount ?? 0;
        grouped[key].extra_details.push({
          dueDate: item.dueDate || [],
          overdueDays: item.overdueDays || [],
          status2: item.status2 || [],
          inInvAmount: item.inInvAmount || [],
          miHvnos: item.miHvnos || [],
        });
      });

      // 2) merge back into saleOrders.value

      saleOrders.value = saleOrders.value.map((order) => {
        // ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡πÉ‡∏ô data ‡∏°‡∏µ deBcode ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö customer_code ‡πÑ‡∏´‡∏°
        const matched = data.find((item) => item.deBcode === order.customer_code);

        const hasMatch = !!matched;
        const deBcode = matched?.deBcode;
        const saleNo = order.sale_no;
        const updates = grouped[saleNo];

        console.log(`üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ${order.customer_code} -> deBcode: ${deBcode} | ‡∏û‡∏ö: ${hasMatch}`);

        if (!hasMatch) {
          console.log(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö deBcode ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö order.customer_code = ${order.customer_code}`);
        }

        if (updates) {
          // ‡πÄ‡∏Å‡πá‡∏ö deBlimit ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ customer_code ‡πÄ‡∏õ‡πá‡∏ô key
          try {
            localStorage.setItem(
              `deBlimit_${order.customer_code}`,
              JSON.stringify(updates.deBlimit)
            );
          } catch (e) {
            console.warn("‚ùó ‡πÄ‡∏Å‡πá‡∏ö localStorage ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", e);
          }

          return {
            ...order,
            deBcreditTerm: updates.deBcreditTerm,
            deBlimit: updates.deBlimit,
            deBsalesP: updates.deBsalesP,
            status2: updates.status2,
            total_paid: updates.total_paid,
            extra_details:
              hasMatch && Array.isArray(updates.extra_details)
                ? updates.extra_details.filter((d) => typeof d === "object" && d !== null)
                : [],
            // extra_details: hasMatch ? updates.extra_details : []
          };
        }

        return order;
      });

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ localStorage
      // localStorage.setItem("deBlimit_all", JSON.stringify(allLimits));

      // const storedLimits = JSON.parse(localStorage.getItem("deBlimit_all") || "[]");
      // console.log("üíæ deBlimit ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ:", storedLimits);

      console.table(
        data.map((item) => ({
          deBcode: item.deBcode,
          customerDocument: item.customerDocument,
          inInvAmount: item.inInvAmount,
        }))
      );

      console.table(
        saleOrders.value.map((order) => ({
          sale_no: order.sale_no,
          customer_code: order.customer_code,
          extra_details: order.extra_details,
        }))
      );

      console.log("üéâ Grouped saleOrders:", saleOrders.value);
    } else {
      Swal.fire({
        title: "Not Data TypeCustomers",
        text: "Response from TypeCustomers is undefined",
        icon: "error",
      });
      console.error("‚ùå No valid data from API");
    }

    isLoading.value = false;
  } catch (e) {
    console.error(e);
  } finally {
    isLoading.value = false;
  }
}

function filteredExtraDetails(order) {
  if (!order.extra_details || !Array.isArray(order.extra_details)) return [];
  return order.extra_details.filter(
    (e) =>
      typeof e === "object" &&
      e !== null &&
      Object.values(e).some((v) => v !== "" && v !== undefined && !Number.isNaN(v))
  );
}

saleOrders.value.forEach((o) => {
  if (Array.isArray(o.extra_details)) {
    console.log(
      o.sale_no,
      o.extra_details.map((e) => typeof e)
    );
  }
});

watch(searchQuery, () => {
  // newVal
  currentPage.value = 1;
  fetchPage(1);
});

onMounted(() => fetchPage(1));

const totalPages = computed(() => Math.ceil(totalRows.value / limit));

function goToPage(page) {
  if (page < 1 || page > totalPages.value) return;
  fetchPage(page);
}
</script>

<!-- <style>
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.5s;
}
.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
</style> -->

<style scoped>
.slide-button-enter-active {
  transition: transform 0.5s ease, opacity 0.5s ease;
}
.slide-button-leave-active {
  transition: transform 0.5s ease, opacity 0.5s ease;
}
.slide-button-enter-from {
  transform: translateX(200%);
  opacity: 0;
}
.slide-button-enter-to {
  transform: translateX(0%);
  opacity: 1;
}
.slide-button-leave-from {
  transform: translateX(0%);
  opacity: 1;
}
.slide-button-leave-to {
  transform: translateX(200%);
  opacity: 0;
}
</style>

<!-- <div v-for="(d, i) in filteredExtraDetails(order)" :key="i"
    class="flex flex-col bg-white shadow-sm rounded-lg p-4 border border-gray-200">

    <div class="text-sm text-gray-800">
      <div class="text-[13px]"><strong class="text-[13px]">Invoice No.:</strong> {{ d.miHvnos }}</div>
      <div class="text-[13px]"><strong class="text-[13px]">Due Date:</strong> {{ d.dueDate }}</div>
      <div class="text-[13px]"><strong class="text-[13px]">Overdue Days:</strong> {{ d.overdueDays }}
      </div>
      <div class="text-[13px]"><strong class="text-[13px]">Status:</strong> {{ d.status2 }}</div>
      <div class="text-[13px]"><strong class="text-[13px]">Amount Due:</strong> {{
        formatCurrency(d.inInvAmount) }}</div>
    </div>

  </div> -->

<!-- // saleOrders.value = saleOrders.value.map(order => {
      //   const deBcode = data.find(item => item.deBcode === order.customer_code)?.deBcode;
      //   console.log('Log Value deBcode:', deBcode, 'for order.CustomerCode:', order.CustomerCode);

      //   if (deBcode) {
      //     console.log(`‡∏û‡∏ö deBcode: ${deBcode} ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö CustomerCode: ${order.customer_code}`);
      //   } else {
      //     console.log(`‡πÑ‡∏°‡πà‡∏û‡∏ö deBcode ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö CustomerCode: ${order.customer_code}`);
      //   }
      //   // ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
      //   const updates = grouped[order.sale_no];
      //   if (updates) {

      //     // ‡∏ñ‡πâ‡∏≤ deBcode ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö customer_code ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á extra_details ‡∏õ‡∏Å‡∏ï‡∏¥
      //     // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô (‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏ß‡πà‡∏≤‡∏á)
      //     // const extraDetailsToShow = deBcode ? updates.extra_details : [];
      //     const extraDetailsToShow = deBcode === order.customer_code ? updates.extra_details : [];


      //     return {
      //       ...order,
      //       deBcreditTerm: updates.deBcreditTerm,
      //       deBlimit: updates.deBlimit,
      //       deBsalesP: updates.deBsalesP,
      //       status2: updates.status2,
      //       total_paid: updates.total_paid,
      //       extra_details: extraDetailsToShow  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ deBcode ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô extra_details
      //       // extra_details: deBcode ? updates.extra_details : []  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ deBcode ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô extra_details
      //       // extra_details: order.customer_code  === deBcode ? [] : updates.extra_details
      //     };
      //   }
      //   return order;

      // }) -->

<!--
 // const res = await axios.post(
    //   `${VITE_API_URL_C_SHARP}/api/TypeCustomers`, payload, {
    //   headers: {
    //     // 'Content-Type': 'application/x-www-form-urlencoded',
    //     'Content-Type': 'application/json', // ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ JSON ‡∏ñ‡πâ‡∏≤ backend ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
    //     'Authorization': `Bearer ${tokendebtStatusType}`
    //   }
    // });

    // const res = await fetch('https://203.154.60.148:58915/api/TypeCustomers', {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json',
    //     'Authorization': `Bearer ${tokendebtStatusType}`
    //   },
    //   body: JSON.stringify(payload),
    //   mode: 'cors'
    // });

    // const data = await res.json();
    // console.log('‚úÖ Response from TypeCustomers:', data);
 -->

<!-- // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ response ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô success = true
    // if (data) {

    //   console.log("üéâ API success:", res.data);

    //   // return;
    //   saleOrders.value = res.data.map(item => ({

    //     // Header
    //     sale_no: item.customerDocument, //customerDocument
    //     customer_code: item.deBcode, // C04366
    //     shop_name: item.deBcontactT, // "‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡πÇ‡∏ä‡∏¢‡∏ä‡∏±‡∏¢‡∏™‡∏∏‡∏ô‡∏ó‡∏£"
    //     deBcreditTerm: item.deBcreditTerm, // ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    //     deBlimit: item.deBlimit, //‡∏ß‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
    //     deBsalesP: item.deBsalesP // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å colum ‡∏£‡∏´‡∏±‡∏™ sale
    //     total_paid: item.final_total_price,
    //     status: item.status2, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    //     created_at: item.created_at,
    //     // total_amount: item.final_total_price,

    //     // Detail
    //     extra_details: res.data.map(item => ({
    //       dueDate: item.dueDate, // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞
    //       overdueDays: item.overdueDays,  //‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á
    //       status2: item.status2, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ
    //       inInvAmount: item.inInvAmount, //‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢
    //     }))

    //   })) -->

<!--
// filter ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
// const filteredOrders = computed(() => {
//   if (!searchQuery.value.trim()) return saleOrders.value

//   const keyword = searchQuery.value.toLowerCase()
//   return saleOrders.value.filter(order =>
//     order.sale_no?.toLowerCase().includes(keyword) ||
//     order.customer_code?.toLowerCase().includes(keyword) ||
//     order.shop_name?.toLowerCase().includes(keyword) ||
//     order.mobile?.toLowerCase().includes(keyword)
//   )
// }) -->

<!-- // const filteredOrders = computed(() => {
//   if (!searchQuery.value.trim()) return saleOrders.value
//   const kw = searchQuery.value.toLowerCase()
//   return saleOrders.value.filter(o =>
//     [o.sale_no, o.customer_code, o.shop_name, o.mobile, o.created_at]
//       .some(str => str.toLowerCase().includes(kw))
//   )
// }) -->

<!--
// onMounted(async () => {
//   try {

//     isLoading.value = true;

//     const response = await axios.get(`${BASE_URL}/api_admin_dashboard/backend/api/list_sale_orders/get_list_sale_order.php`)
//     console.log('Check log responseData:', response.data.data.list_order);

//     saleOrders.value = (response.data.data.list_order || []).map(item => ({
//       id: item.id,
//       sale_no: item.document_no,
//       customer_code: item.customer_code,
//       shop_name: item.full_name,
//       mobile: item.phone,
//       total_amount: item.final_total_price,
//       total_paid: item.final_total_price,
//       status: item.status,
//       created_at: item.created_at
//     }));

//     // saleOrders.value = response.data.data.list_order || []
//     totalRows.value = response.data.total || response.data.data.list_order.length

//     isLoading.value = false;
//   } catch (error) {
//     console.error('‚ùå Failed to load sale orders:', error)
//   }
// }); -->
